<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Trouble Shooting | DoShiCo</title>
<meta property="og:title" content="Trouble Shooting" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Domain Shift challenge for Control." />
<meta property="og:description" content="Domain Shift challenge for Control." />
<link rel="canonical" href="http://localhost:4000/trouble" />
<meta property="og:url" content="http://localhost:4000/trouble" />
<meta property="og:site_name" content="DoShiCo" />
<script type="application/ld+json">
{"name":null,"description":"Domain Shift challenge for Control.","author":null,"@type":"WebPage","url":"http://localhost:4000/trouble","publisher":null,"image":null,"headline":"Trouble Shooting","dateModified":null,"datePublished":null,"sameAs":null,"mainEntityOfPage":null,"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="description" content="Domain Shift challenge for Control."/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/assets/css/style.css?v=6195bc27c3511918ca7590082cff9f5a5241f384">
  </head>
  <body>
    <section class="page-header">
     <h1 class="project-name">Trouble Shooting</h1>
     <h2 class="project-tagline">K. Kelchtermans</h2>

    </section>

    <section class="main-content">
      <p>Starting to work with docker can be a bit more challenging as one might expect. We added this page to cover the most probable issues step by step.</p>

<h1 id="installing-prerequisites">Installing Prerequisites</h1>

<p>In order to run the docker image the following packages are required: <a href="https://www.docker.com/get-docker" title="get-docker"><strong>docker (CE)</strong></a>, <a href="https://developer.nvidia.com/cuda-downloads"><strong>nvidia-drivers</strong></a> and <a href="https://github.com/NVIDIA/nvidia-docker"><strong>nvidia-docker</strong></a>.</p>

<p><a href="https://www.docker.com/get-docker" title="get-docker"><strong>docker (CE)</strong></a> should be accessible on linux, windows and mac but in for this troubleshoot it is only tested on linux. If you are new to docker, I would recommend going through the first set of <a href="https://docs.docker.com/get-started">tutorials</a>. The installation is very straightforward. If everything went well you should be able to run:</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>docker run hello-world
Hello ...
<span class="gp">$ </span>docker --version
</code></pre>
</div>

<p>For getting <a href="https://developer.nvidia.com/cuda-downloads"><strong>nvidia-drivers</strong></a>, it is recommended to install the drivers from a package manager like apt or dnf. You might want to install the CUDA toolkit and Cudnn libraries, though this is not required as they are already included in the docker image. Good instructions for installing nvidia on ubuntu can be found <a href="https://gist.github.com/wangruohui/df039f0dc434d6486f5d4d098aa52d07" title="Install NVIDIA Driver and CUDA">here</a>. Note that you’ll have to reinstall your drivers at each kernel update. As a sidenote it is recommended to keep the driver run file after installation as it can often be used to uninstall the drivers correctly.
If everything went well you should be able to run:</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>nvidia-smi
</code></pre>
</div>

<p><a href="https://github.com/NVIDIA/nvidia-docker"><strong>Nvidia-docker</strong></a> ensures that when a docker container is run that uses the nvidia GPU, the drivers are mounted on the correct place. It is a daemon that after installation and rebooting should run in the background publishing the required information on <a href="http://localhost:3476/docker/cli">your localhost</a> where it provides the necessary flags. These flags are added to the run command when you use <code class="highlighter-rouge">nvidia-docker</code> instead of <code class="highlighter-rouge">docker</code>. Test it out with:</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>nvidia-docker run --rm nvidia/cuda nvidia-smi
</code></pre>
</div>

<p>Please validate if they are all three installed correctly before diving deeper.</p>

<h1 id="troubleshoot">Troubleshoot</h1>

<h2 id="running-gzserver-within-docker-image">Running gzserver within docker image</h2>
<p>In order to make this work you need:</p>
<ul>
  <li>nvidia driver installed and mounted by nvidia-docker</li>
  <li>export LD_LIBRARY_PATH=/usr/local/nvidia/lib64</li>
  <li>add a display when running the container as user 1000
    <div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>gzserver --verbose
...[Msg] Waiting <span class="k">for </span>master.
<span class="o">[</span>Msg] Connected to gazebo master @ http://127.0.0.1:11345
<span class="o">[</span>Msg] Publicized address: 172.17.0.2
libGL error: No matching fbConfigs or visuals found
libGL error: failed to load driver: swrast
X Error of failed request:  BadValue <span class="o">(</span>integer parameter out of range <span class="k">for </span>operation<span class="o">)</span>
Major opcode of failed request:  154 <span class="o">(</span>GLX<span class="o">)</span>
Minor opcode of failed request:  3 <span class="o">(</span>X_GLXCreateContext<span class="o">)</span>
Value <span class="k">in </span>failed request:  0x0
Serial number of failed request:  30
Current serial number <span class="k">in </span>output stream:  31
<span class="gp">$ </span><span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/usr/local/nvidia/lib64
<span class="gp">$ </span>gzserver --verbose
...[Msg] Connected to gazebo master @ http://127.0.0.1:11345
<span class="o">[</span>Msg] Publicized address: 172.17.0.2
</code></pre>
    </div>
  </li>
</ul>

<h2 id="gazebo-models-not-found">GAZEBO models not found</h2>
<p>In case you have a similar error as the title please ensure that the environment variable GAZEBO_MODEL_PATH is set correctly.</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">export </span><span class="nv">GAZEBO_MODEL_PATH</span><span class="o">=</span>/home/<span class="k">${</span><span class="nv">username</span><span class="k">}</span>/simsup_ws/src/simulation_supervised/simulation_supervised_demo/models
</code></pre>
</div>

<h2 id="uninstall">Uninstall</h2>
<p>If you followed the instruction scripts, all the data and code should be grouped in a docker_home directory in your home folder.
In the case that you used your own home folder as docker_home, you’ll have to remove the following dirs:</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>rm -rf ~/pilot_data ~/drone_ws ~/simsup_ws ~/tensorflow
</code></pre>
</div>
<p>You can get rid of the image in docker with <code class="highlighter-rouge">docker rmi doshico_image doshico_image</code>.</p>

<!-- OLD TEXT NOT USED
Running the docker image with your home folder mounted and the local graphical session forwarded should not be more than a few lines:

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># nvidia-docker ensures that the nvidia drivers is mounted with the correct version</span>
<span class="c"># -e option sets the correct environment variable</span>
<span class="c"># -v option mounts a directory locally to a directory in the docker container</span>
<span class="c"># --name your container so that you can commit it later to an image for reuse</span>
<span class="c"># add -it for interactive session</span>
<span class="c"># bash demands a running bash shell</span>
<span class="gp">$ </span>sudo docker run <span class="se">\</span>
	--name container_name <span class="se">\</span>
	-it <span class="se">\</span>
	kkelchte/ros_gazebo_tensorflow <span class="se">\</span>
	bash
<span class="gp">root@somenumbers:/# </span>id
	<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span></code></pre></figure>


You should now be able to enter the image as a root (uid=0). This will prevent write access to your home folder as it has a different user identity. It is therefore best to add yourself as a user in current container.

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># in a different window check your normal user id</span>
<span class="gp">$ </span><span class="nb">echo</span> <span class="nv">$UID</span>
1234
<span class="c"># if your user id is not 1000, you'll have to add it in the docker container with the following command</span>
<span class="gp">root@somenumbers:/# </span>adduser --uid YOURID YOURNAME
<span class="c"># see if you can enter in the running container from another terminal window as the other user</span>
<span class="gp">$ </span>sudo docker <span class="nb">exec</span> <span class="se">\</span>
		-it <span class="se">\</span>
		-u YOURID <span class="se">\</span>
		-v <span class="nv">$HOME</span>:/home/guest<span class="se">\</span>
		-e <span class="nv">HOME</span><span class="o">=</span>/home/guest<span class="se">\</span>
		container_name bash
<span class="gp">YOURNAME@somenumbers:/$ </span><span class="nb">cd
</span><span class="gp">YOURNAME@somenumbers:~$ </span><span class="nb">pwd</span>
/home/guest
<span class="gp">YOURNAME@somenumbers:~$ </span>touch <span class="nb">test</span>
<span class="c"># if your user ID was added correctly you can now update the container to a local image </span>
<span class="c"># with the 'docker commit' command in a new local terminal</span>
<span class="gp">$ </span>sudo docker commit container_name YOUR_DOCKER_REPOSITORY</code></pre></figure>


Congratulations! You have created a local copy of my docker image with your user ID added. Now you can adjust you own mounted home folder from within the image.

It is time to make some checks to see if everything went well.

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># start your container from your updated image</span>
<span class="c"># --rm deletes the container after logging out</span>
<span class="c"># -v mounts your home directory to /home/YOURNAME</span>
<span class="c"># -v /tmp/.X11-unix mounts the X server allowing software within use it</span>
<span class="c"># -e sets the DISPLAY environments variable</span>
<span class="c"># it is important to run a container from the image from your repository as you have a user account in it.</span>
<span class="gp">$ </span>sudo docker run <span class="se">\</span>
	-it <span class="se">\</span>
	--rm <span class="se">\</span>
	-u YOURID <span class="se">\</span>
	-v <span class="nv">$HOME</span>:/home/YOURNAME <span class="se">\</span>
	-e <span class="nv">$HOME</span><span class="o">=</span>/home/YOURNAME <span class="se">\</span>
	-v /tmp/.X11-unix:/tmp/.X11-unix <span class="se">\</span>
	-e <span class="nv">DISPLAY</span><span class="o">=</span><span class="nv">$DISPLAY</span> <span class="se">\</span>
	YOUR_DOCKER_REPOSITORY bash
<span class="c"># $$ indicates the bash line within the container</span>
<span class="c"># source ros setup:</span>
<span class="gp">$$ </span><span class="nb">source</span> <span class="s2">"/opt/ros/</span><span class="nv">$ROS_DISTRO</span><span class="s2">/setup.bash"</span>
<span class="c"># start ros and a gui to see if it displays correctle:</span>
<span class="gp">$$ </span>roscore &amp;
...
<span class="gp">$$ </span>rosrun rqt_gui rqt_gui
<span class="c"># If everything went correctly you should see the rqt graphical user interface running on ROS</span></code></pre></figure>


Preferrably your computer has a Nvidia GPU with nvidia drivers and the CUDA toolkit(>8.0) installed. This is required for Tensorflow-gpu. If not, a local [Tensorflow](https://www.tensorflow.org/install/install_linux#InstallingVirtualenv) version can be installed for instance in a virtual environment in your mounted home folder. 

In case you have a Nvidia-GPU the <a href="https://github.com/NVIDIA/nvidia-docker" target="_blank">Nvidia-docker plugin (1.0.1)</a> should be installed. Check the installation in this way:


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>sudo nvidia-docker run <span class="se">\</span>
		-it <span class="se">\</span>
		-u YOURID <span class="se">\</span>
		-v <span class="nv">$HOME</span>:/home/guest<span class="se">\</span>
		-e <span class="nv">HOME</span><span class="o">=</span>/home/guest<span class="se">\</span>
		container_name bash
<span class="o">[</span>inside container]<span class="nv">$ </span>ls /dev
...nvidia0...
<span class="c">#There</span></code></pre></figure>
 -->



      <footer class="site-footer">
          <span class="site-footer-owner"><a href="/doshico">Home</a> (Contact: klaas.kelchtermans ~at~ esat.kuleuven.be).</span>
          <!-- <span class="site-footer-owner"><a href="https://kkelchte.github.io/doshico">Back</a> (Contact: klaas.kelchtermans ~at~ esat.kuleuven.be).</span> -->
      </footer>
    </section>

    
  </body>



</html>
